<!DOCTYPE html>

<!-- Add a title -->
<h1 style="color:red;font-size:40px;">CS498 Final Project Narrative Dashboard: Covid-19 Re-opening</h1>

<!-- Add a bit of text -->
<p style="color:rebeccapurple;font-size:18px;font-weight:bold;text-align:left;">The national lockdown and staying home order start officially on 2020-03-11 for Covid-19 pandemic. During pandemic time period, which state is the top 1 risky? 
    What is the trend for this stateâ€™s daily new cases as compared to California? After the stage 2 resilience plan, can you suggest which state could be faster to moving to stage 3 reopening plan? And why?</p>
<p style="color:black;font-size:14px;text-align:left;">Any public dataset can be used for this assignment. For example, this assignment provides an opportunity to further analyze the spread of the COVID-19 virus. Some datasets include:</p>
<p style="color:rebeccapurple;font-size:16px;font-weight:bold;text-align:left;">This is the public Covid-19 dataset <a href= "https://github.com/nytimes/covid-19-data">from New York Times (US)</a></p>
<p style="color:black;font-size:14px;text-align:left;">The data findings reveals the Covid-19 Deaths by Race and Ethnicity in the U.S. <a href= "https://www.apmresearchlab.org/covid/deaths-by-race">from APM Research Lab</a></p> 
<p style="color:black;font-size:14px;text-align:left;">You can also find other datasets, or combine these or other datasets, so long as all of the datasets are publicly available. These datasets have created some comprehensive dashboards as well as some more targeted analyses that focus on a smaller number of charts.</p>

<!-- Add a link -->
<p style="color:black;font-size:16px;font-weight:bold;text-align:left;">Background: This is <a href="https://public.tableau.com/profile/xiaojiao.zang#!/vizhome/Cov19_us_states/USNewCasesDashboard?publish=yes">a link to the Covid-19 Tableau Dashboard</a></p>
<p style="color:red;font-size:16px;font-weight:bold;text-align:left;">U.S. Overall Cases by Top 7 States by July 31, 2020</p>
<p style="color:black;font-size:14px;font-weight:bold;">Select Your Data</p>

<!-- Add Pie Chart I with Data1/Data2 Option-->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Color scale -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<!-- Add 2 buttons -->
<button onclick="update(data1)">Data 1</button>
<button onclick="update(data2)">Data 2</button>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>
<script>


    // set the dimensions and margins of the graph
    var width = 450
        height = 450
        margin = 40
    
    // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
    var radius = Math.min(width, height) / 2 - margin
    
    // append the svg object to the div called 'my_dataviz'
    var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr("transform","translate(350,25)")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    
    // create 2 data_set
    var data1 = {a: 9, b: 20, c:30, d:8, e:12}
    var data2 = {a: 6, b: 16, c:20, d:14, e:19, f:12}
    
    // set the color scale
    var color = d3.scaleOrdinal()
      .domain(["a", "b", "c", "d", "e", "f"])
      .range(d3.schemeDark2);
    
    // A function that create / update the plot for a given variable:
    function update(data) {
    
      // Compute the position of each group on the pie:
      var pie = d3.pie()
        .value(function(d) {return d.value; })
        .sort(function(a, b) { console.log(a) ; return d3.ascending(a.key, b.key);} ) // This make sure that group order remains the same in the pie chart
      var data_ready = pie(d3.entries(data))
    
      // map to data
      var u = svg.selectAll("path")
        .data(data_ready)
    
      // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
      u
        .enter()
        .append('path')
        .merge(u)
        .transition()
        .duration(1000)
        .attr('d', d3.arc()
          .innerRadius(0)
          .outerRadius(radius)
        )
        .attr('fill', function(d){ return(color(d.data.key)) })
        .attr("stroke", "white")
        .style("stroke-width", "2px")
        .style("opacity", 1)
    
      // remove the group that is not present anymore
      u
        .exit()
        .remove()
    
    }
    
    // Initialize the plot with the first dataset
    update(data1)
	//update(data2)
    
</script>

<!--Chart 2. Donuts Chart-->
<!DOCTYPE html>
<html>
  <head>    
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>CS 498 Narrative Dashboard</title>
   <!--<script type="text/javascript" src="d3/d3.v2.js"></script>-->
    <script src="https://d3js.org/d3.v2.js"></script>
	<!-- Note: I made good use of the sample code provided by the D3JS community and extended it to fit my needs to create this simple dashboard -->
    <style type="text/css">


#pieChart {    
	position:absolute;
	top:380px;
	left:30px;
	width:400px;
	height: 400px; 
}



#lineChart {    
	position:absolute;
	top:550px;
	left:490px;
	height: 150px;
}

#barChart {
	position:absolute;
	top:500px;
	left:490px;
	height: 650px;
}

.slice {
   font-size: 12pt;
   font-family: Verdana;
   fill: white; //svg specific - instead of color
   font-weight: bold;	
  		} 

/*for line chart*/
.axis path, .axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges; //The shape-rendering property is an SVG attribute, used here to make sure our axis and its tick mark lines are pixel-perfect. 
}

.line {
  fill: none;
  /*stroke: steelblue;*/
  stroke-width: 3.5px;
}

.dot {
  /*fill: white;*/
  /*stroke: steelblue;*/
  stroke-width: 1.8px;
  }
				

.axis text {
    font-family: Verdana;
    font-size: 15px;
}

.title {
	 font-family: Verdana;
    font-size: 19px;	
		
}

.xAxis {
    font-family: verdana;
    font-size: 15px;
    fill: black;
}  

.yAxis {
    font-family: verdana;
    font-size: 11px;
    fill: white;
}

  
table {
	border-collapse:collapse;
	border: 0px;	
	font-family: Verdana;	
	color: #5C5558;
	font-size: 12px;
	text-align: right;			
}

td {
	padding-left: 10px;		
}

#lineChartTitle1 {
	font-family: Verdana;
	font-size  : 15px;
	fill       : lightslategray;
	font-weight: bold;
	text-anchor: middle;
}

#lineChartTitle2 {
	font-family: Verdana;
	font-size  : 30px;
	fill       : gray;
	text-anchor: middle;
	font-weight: bold;
	/*font-style: italic;*/
}
				 
    </style>
  </head>
  <body>
  
    <div id="pieChart"></div>
    <div id="barChart"></div>  
    <div id="lineChart"></div>
    <script type="text/javascript">
    
/*
################ FORMATS ##################
-------------------------------------------
*/


var 	formatAsPercentage = d3.format("%"),
		formatAsPercentage1Dec = d3.format(".1%"),
		formatAsInteger = d3.format(","),
		fsec = d3.time.format("%S s"),
		fmin = d3.time.format("%M m"),
		fhou = d3.time.format("%H h"),
		fwee = d3.time.format("%a"),
		fdat = d3.time.format("%d d"),
		fmon = d3.time.format("%b")
		;

/*
############# PIE CHART ###################
-------------------------------------------
*/

function dsPieChart(){

	var dataset = [
		  {category: "California", measure: 0.30},
	      {category: "Florida", measure: 0.25},
	      {category: "New York", measure: 0.15},
	      {category: "Georgia", measure: 0.05},
	      {category: "Texas", measure: 0.18},
	      {category: "New Jersey", measure:0.04},
	      {category: "Illinois", measure: 0.03}
	      ]
	      ;

	var    width = 400,
		   height = 400,
		   outerRadius = Math.min(width, height) / 2,
		   innerRadius = outerRadius * .999,   
		   // for animation
		   innerRadiusFinal = outerRadius * .5,
		   innerRadiusFinal3 = outerRadius* .45,
		   color = d3.scale.category20()    //builtin range of colors
		   ;
	    
	var vis = d3.select("#pieChart")
	     .append("svg:svg")              //create the SVG element inside the <body>
	     .data([dataset])                   //associate our data with the document
	         .attr("width", width)           //set the width and height of our visualization (these will be attributes of the <svg> tag
	         .attr("height", height)
	     	 .append("svg:g")                //make a group to hold our pie chart
	         .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")")    //move the center of the pie chart from 0, 0 to radius, radius
				;
				
   var arc = d3.svg.arc()              //this will create <path> elements for us using arc data
        	.outerRadius(outerRadius).innerRadius(innerRadius);
   
   // for animation
   var arcFinal = d3.svg.arc().innerRadius(innerRadiusFinal).outerRadius(outerRadius);
	var arcFinal3 = d3.svg.arc().innerRadius(innerRadiusFinal3).outerRadius(outerRadius);

   var pie = d3.layout.pie()           //this will create arc data for us given a list of values
        .value(function(d) { return d.measure; });    //we must tell it out to access the value of each element in our data array

   var arcs = vis.selectAll("g.slice")     //this selects all <g> elements with class slice (there aren't any yet)
        .data(pie)                          //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties) 
        .enter()                            //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
            .append("svg:g")                //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
               .attr("class", "slice")    //allow us to style things in the slices (like text)
               .on("mouseover", mouseover)
    				.on("mouseout", mouseout)
    				.on("click", up)
    				;
    				
        arcs.append("svg:path")
               .attr("fill", function(d, i) { return color(i); } ) //set the color for each slice to be chosen from the color function defined above
               .attr("d", arc)     //this creates the actual SVG path using the associated data (pie) with the arc drawing function
					.append("svg:title") //mouseover title showing the figures
				   .text(function(d) { return d.data.category + ": " + formatAsPercentage(d.data.measure); });			

        d3.selectAll("g.slice").selectAll("path").transition()
			    .duration(750)
			    .delay(10)
			    .attr("d", arcFinal )
			    ;
	
	  // Add a label to the larger arcs, translated to the arc centroid and rotated.
	  // source: http://bl.ocks.org/1305337#index.html
	  arcs.filter(function(d) { return d.endAngle - d.startAngle > .2; })
	  		.append("svg:text")
	      .attr("dy", ".35em")
	      .attr("text-anchor", "middle")
	      .attr("transform", function(d) { return "translate(" + arcFinal.centroid(d) + ")rotate(" + angle(d) + ")"; })
	      //.text(function(d) { return formatAsPercentage(d.value); })
	      .text(function(d) { return d.data.category; })
	      ;
	   
	   // Computes the label angle of an arc, converting from radians to degrees.
		function angle(d) {
		    var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
		    return a > 90 ? a - 180 : a;
		}
		    
		
		// Pie chart title			
		vis.append("svg:text")
	     	.attr("dy", ".35em")
	      .attr("text-anchor", "middle", "font-weight")
		  .text("U.S.Cases:4,663,742")
	      .attr("class","title")
	      ;		    


		
	function mouseover() {
	  d3.select(this).select("path").transition()
	      .duration(750)
	        		//.attr("stroke","red")
	        		//.attr("stroke-width", 1.5)
	        		.attr("d", arcFinal3)
	        		;
	}
	
	function mouseout() {
	  d3.select(this).select("path").transition()
	      .duration(750)
	        		//.attr("stroke","blue")
	        		//.attr("stroke-width", 1.5)
	        		.attr("d", arcFinal)
	        		;
	}
	
	function up(d, i) {
	
				/* update bar chart when user selects piece of the pie chart */
				//updateBarChart(dataset[i].category);
				updateBarChart(d.data.category, color(i));
				updateLineChart(d.data.category, color(i));
			 
	}
}

dsPieChart();

/*
############# BAR CHART ###################
-------------------------------------------
*/



var datasetBarChart = [
{ group: "All", category: "White", measure: 65950 }, 
{ group: "All", category: "Black", measure: 29946 }, 
{ group: "All", category: "Latino", measure: 22226 }, 
{ group: "All", category: "Asian", measure: 5552 }, 
{ group: "All", category: "Unknown", measure: 32228 }, 
{ group: "California", category: "White", measure: 2318 }, 
{ group: "California", category: "Black", measure: 654 }, 
{ group: "California", category: "Latino", measure: 3386 }, 
{ group: "California", category: "Asian", measure: 998 }, 
{ group: "California", category: "Unknown", measure: 1860 }, 
{ group: "Florida", category: "White", measure: 2451 }, 
{ group: "Florida", category: "Black", measure: 1031 }, 
{ group: "Florida", category: "Latino", measure: 1327}, 
{ group: "Florida", category: "Asian", measure: 32 }, 
{ group: "Florida", category: "Unknown", measure: 2002 }, 
{ group: "New York", category: "White", measure: 9687 }, 
{ group: "New York", category: "Black", measure: 7604 }, 
{ group: "New York", category: "Latino", measure: 7659 }, 
{ group: "New York", category: "Asian", measure: 2079 }, 
{ group: "New York", category: "Unknown", measure: 5660 }, 
{ group: "Georgia", category: "White", measure: 1463 }, 
{ group: "Georgia", category: "Black", measure: 1488 }, 
{ group: "Georgia", category: "Latino", measure: 189 }, 
{ group: "Georgia", category: "Asian", measure: 51 }, 
{ group: "Georgia", category: "Unknown", measure: 561 }, 
{ group: "Texas", category: "White", measure: 1033 }, 
{ group: "Texas", category: "Black", measure: 504 }, 
{ group: "Texas", category: "Latino", measure: 1038 }, 
{ group: "Texas", category: "Asian", measure: 80 }, 
{ group: "Texas", category: "Unknown", measure: 3914 }, 
{ group: "New Jersey", category: "White", measure: 3253 }, 
{ group: "New Jersey", category: "Black", measure: 2018 }, 
{ group: "New Jersey", category: "Latino", measure: 1530 }, 
{ group: "New Jersey", category: "Asian", measure: 597 }, 
{ group: "New Jersey", category: "Unknown", measure: 5319 }, 
{ group: "Illinois", category: "White", measure: 3253 }, 
{ group: "Illinois", category: "Black", measure: 2018 }, 
{ group: "Illinois", category: "Latino", measure: 1530 }, 
{ group: "Illinois", category: "Asian", measure: 349 }, 
{ group: "Illinois", category: "Unknown", measure: 346 }, 
]
;

// set initial group value
var group = "All";

function datasetBarChosen(group) {
	var ds = [];
	for (x in datasetBarChart) {
		 if(datasetBarChart[x].group==group){
		 	ds.push(datasetBarChart[x]);
		 } 
		}
	return ds;
}


function dsBarChartBasics() {

		var margin = {top: 30, right: 5, bottom: 20, left: 50},
		width = 500 - margin.left - margin.right,
	   height = 250 - margin.top - margin.bottom,
		colorBar = d3.scale.category20(),
		barPadding = 1
		;
		
		return {
			margin : margin, 
			width : width, 
			height : height, 
			colorBar : colorBar, 
			barPadding : barPadding
		}			
		;
}

function dsBarChart() {

	var firstDatasetBarChart = datasetBarChosen(group);         	
	
	var basics = dsBarChartBasics();
	
	var margin = basics.margin,
		width = basics.width,
	   height = basics.height,
		colorBar = basics.colorBar,
		barPadding = basics.barPadding
		;
					
	var 	xScale = d3.scale.linear()
						.domain([0, firstDatasetBarChart.length])
						.range([0, width])
						;
						
	// Create linear y scale 
	// Purpose: No matter what the data is, the bar should fit into the svg area; bars should not
	// get higher than the svg height. Hence incoming data needs to be scaled to fit into the svg area.  
	var yScale = d3.scale.linear()
			// use the max funtion to derive end point of the domain (max value of the dataset)
			// do not use the min value of the dataset as min of the domain as otherwise you will not see the first bar
		   .domain([0, d3.max(firstDatasetBarChart, function(d) { return d.measure; })])
		   // As coordinates are always defined from the top left corner, the y position of the bar
		   // is the svg height minus the data value. So you basically draw the bar starting from the top. 
		   // To have the y position calculated by the range function
		   .range([height, 0])
		   ;
	
	//Create SVG element
	
	var svg = d3.select("#barChart")
			.append("svg")
		    .attr("width", width + margin.left + margin.right)
		    .attr("height", height + margin.top + margin.bottom)
		    .attr("id","barChartPlot")
		    ;
	
	var plot = svg
		    .append("g")
		    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
		    ;
	            
	plot.selectAll("rect")
		   .data(firstDatasetBarChart)
		   .enter()
		   .append("rect")
			.attr("x", function(d, i) {
			    return xScale(i);
			})
		   .attr("width", width / firstDatasetBarChart.length - barPadding)   
			.attr("y", function(d) {
			    return yScale(d.measure);
			})  
			.attr("height", function(d) {
			    return height-yScale(d.measure);
			})
			.attr("fill", "lightgrey")
			;
	
		
	// Add y labels to plot	
	
	plot.selectAll("text")
	.data(firstDatasetBarChart)
	.enter()
	.append("text")
	.text(function(d) {
			return formatAsInteger(d3.round(d.measure));
	})
	.attr("text-anchor", "middle")
	// Set x position to the left edge of each bar plus half the bar width
	.attr("x", function(d, i) {
			return (i * (width / firstDatasetBarChart.length)) + ((width / firstDatasetBarChart.length - barPadding) / 2);
	})
	.attr("y", function(d) {
			return yScale(d.measure) + 14;
	})
	.attr("class", "yAxis")
	/* moved to CSS			   
	.attr("font-family", "sans-serif")
	.attr("font-size", "11px")
	.attr("fill", "white")
	*/
	;
	
	// Add x labels to chart	
	
	var xLabels = svg
		    .append("g")
		    .attr("transform", "translate(" + margin.left + "," + (margin.top + height)  + ")")
		    ;
	
	xLabels.selectAll("text.xAxis")
		  .data(firstDatasetBarChart)
		  .enter()
		  .append("text")
		  .text(function(d) { return d.category;})
		  .attr("text-anchor", "middle")
			// Set x position to the left edge of each bar plus half the bar width
						   .attr("x", function(d, i) {
						   		return (i * (width / firstDatasetBarChart.length)) + ((width / firstDatasetBarChart.length - barPadding) / 2);
						   })
		  .attr("y", 15)
		  .attr("class", "xAxis")
		  //.attr("style", "font-size: 12; font-family: Helvetica, sans-serif")
		  ;			
	 
	// Title
	
	svg.append("text")
		.attr("x", (width + margin.left + margin.right)/2)
		.attr("y", 15)
		.attr("class","title")				
		.attr("text-anchor", "middle")
		.text("U.S. Deaths by Race and Ethnicity")
		;
}

dsBarChart();

 /* ** UPDATE CHART ** */
 
/* updates bar chart on request */

function updateBarChart(group, colorChosen) {
	
		var currentDatasetBarChart = datasetBarChosen(group);
		
		var basics = dsBarChartBasics();
	
		var margin = basics.margin,
			width = basics.width,
		   height = basics.height,
			colorBar = basics.colorBar,
			barPadding = basics.barPadding
			;
		
		var 	xScale = d3.scale.linear()
			.domain([0, currentDatasetBarChart.length])
			.range([0, width])
			;
		
			
		var yScale = d3.scale.linear()
	      .domain([0, d3.max(currentDatasetBarChart, function(d) { return d.measure; })])
	      .range([height,0])
	      ;
	      
	   var svg = d3.select("#barChart svg");
	      
	   var plot = d3.select("#barChartPlot")
	   	.datum(currentDatasetBarChart)
		   ;
	
	  		/* Note that here we only have to select the elements - no more appending! */
	  	plot.selectAll("rect")
	      .data(currentDatasetBarChart)
	      .transition()
			.duration(750)
			.attr("x", function(d, i) {
			    return xScale(i);
			})
		   .attr("width", width / currentDatasetBarChart.length - barPadding)   
			.attr("y", function(d) {
			    return yScale(d.measure);
			})  
			.attr("height", function(d) {
			    return height-yScale(d.measure);
			})
			.attr("fill", colorChosen)
			;
		
		plot.selectAll("text.yAxis") // target the text element(s) which has a yAxis class defined
			.data(currentDatasetBarChart)
			.transition()
			.duration(750)
		   .attr("text-anchor", "middle")
		   .attr("x", function(d, i) {
		   		return (i * (width / currentDatasetBarChart.length)) + ((width / currentDatasetBarChart.length - barPadding) / 2);
		   })
		   .attr("y", function(d) {
		   		return yScale(d.measure) + 14;
		   })
		   .text(function(d) {
				return formatAsInteger(d3.round(d.measure));
		   })
		   .attr("class", "yAxis")					 
		;
		

		svg.selectAll("text.title") // target the text element(s) which has a title class defined
			.attr("x", (width + margin.left + margin.right)/2)
			.attr("y", 15)
			.attr("class","title")				
			.attr("text-anchor", "middle")
			.text(group + "'s Deaths by Race and Ethnicity")
		;
}


/*
############# LINE CHART ##################
-------------------------------------------
*/

var datasetLineChart = [
{ group: "All", category: 2008, measure: 289309 }, 
{ group: "All", category: 2009, measure: 234998 }, 
{ group: "All", category: 2010, measure: 310900 }, 
{ group: "All", category: 2011, measure: 223900 }, 
{ group: "All", category: 2012, measure: 155902 }, 
{ group: "California", category: 2008, measure: 81006.52 }, 
{ group: "California", category: 2009, measure: 70499.4 }, 
{ group: "California", category: 2010, measure: 96379 }, 
{ group: "California", category: 2011, measure: 64931 }, 
{ group: "California", category: 2012, measure: 9216 }, 
{ group: "Florida", category: 2008, measure: 63647.98 }, 
{ group: "Florida", category: 2009, measure: 61099.48 }, 
{ group: "Florida", category: 2010, measure: 87052 }, 
{ group: "Florida", category: 2011, measure: 58214 }, 
{ group: "Florida", category: 2012, measure: 6843 }, 
{ group: "Georgia", category: 2008, measure: 23144.72 }, 
{ group: "Georgia", category: 2009, measure: 14099.88 }, 
{ group: "Georgia", category: 2010, measure: 15545 }, 
{ group: "Georgia", category: 2011, measure: 11195 }, 
{ group: "Georgia", category: 2012, measure: 3752 }, 
{ group: "New York", category: 2008, measure: 34717.08 }, 
{ group: "New York", category: 2009, measure: 30549.74 }, 
{ group: "New York", category: 2010, measure: 34199 }, 
{ group: "New York", category: 2011, measure: 33585 }, 
{ group: "New York", category: 2012, measure: 32689 }, 
{ group: "Texas", category: 2008, measure: 69434.16 }, 
{ group: "Texas", category: 2009, measure: 46999.6 }, 
{ group: "Texas", category: 2010, measure: 62180 }, 
{ group: "Texas", category: 2011, measure: 40302 }, 
{ group: "Texas", category: 2012, measure: 6569 }, 
{ group: "New Jersey", category: 2008, measure: 7232.725 }, 
{ group: "New Jersey", category: 2009, measure: 4699.96 }, 
{ group: "New Jersey", category: 2010, measure: 6218 }, 
{ group: "New Jersey", category: 2011, measure: 8956 }, 
{ group: "New Jersey", category: 2012, measure: 15905 }, 
{ group: "Illinois", category: 2008, measure: 10125.815 }, 
{ group: "Illinois", category: 2009, measure: 7049.94 }, 
{ group: "Illinois", category: 2010, measure: 9327 }, 
{ group: "Illinois", category: 2011, measure: 6717 }, 
{ group: "Illinois", category: 2012, measure: 7496 }
]
;

// set initial category value
var group = "All";

function datasetLineChartChosen(group) {
	var ds = [];
	for (x in datasetLineChart) {
		 if(datasetLineChart[x].group==group){
		 	ds.push(datasetLineChart[x]);
		 } 
		}
	return ds;
}

function dsLineChartBasics() {

	var margin = {top: 20, right: 10, bottom: 0, left: 50},
	    width = 500 - margin.left - margin.right,
	    height = 150 - margin.top - margin.bottom
	    ;
		
		return {
			margin : margin, 
			width : width, 
			height : height
		}			
		;
}


function dsLineChart() {

	var firstDatasetLineChart = datasetLineChartChosen(group);    
	
	var basics = dsLineChartBasics();
	
	var margin = basics.margin,
		width = basics.width,
	   height = basics.height
		;

	var xScale = d3.scale.linear()
	    .domain([0, firstDatasetLineChart.length-1])
	    .range([0, width])
	    ;

	var yScale = d3.scale.linear()
	    .domain([0, d3.max(firstDatasetLineChart, function(d) { return d.measure; })])
	    .range([height, 0])
	    ;
	
	var line = d3.svg.line()
	    //.x(function(d) { return xScale(d.category); })
	    .x(function(d, i) { return xScale(i); })
	    .y(function(d) { return yScale(d.measure); })
	    ;
	
	var svg = d3.select("#lineChart").append("svg")
	    .datum(firstDatasetLineChart)
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	    // create group and move it so that margins are respected (space for axis and title)
	    
	var plot = svg
	    .append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
	    .attr("id", "lineChartPlot")
	    ;

		/* descriptive titles as part of plot -- start */
	var dsLength=firstDatasetLineChart.length;

	plot.append("text")
		.text(firstDatasetLineChart[dsLength-1].measure)
		.attr("id","lineChartTitle2")
		.attr("x",width/2)
		.attr("y",height/2)	
		;
	/* descriptive titles -- end */
	    
	plot.append("path")
	    .attr("class", "line")
	    .attr("d", line)	
	    // add color
		.attr("stroke", "lightgrey")
	    ;
	  
	plot.selectAll(".dot")
	    .data(firstDatasetLineChart)
	  	 .enter().append("circle")
	    .attr("class", "dot")
	    //.attr("stroke", function (d) { return d.measure==datasetMeasureMin ? "red" : (d.measure==datasetMeasureMax ? "green" : "steelblue") } )
	    .attr("fill", function (d) { return d.measure==d3.min(firstDatasetLineChart, function(d) { return d.measure; }) ? "red" : (d.measure==d3.max(firstDatasetLineChart, function(d) { return d.measure; }) ? "green" : "white") } )
	    //.attr("stroke-width", function (d) { return d.measure==datasetMeasureMin || d.measure==datasetMeasureMax ? "3px" : "1.5px"} )
	    .attr("cx", line.x())
	    .attr("cy", line.y())
	    .attr("r", 3.5)
	    .attr("stroke", "lightgrey")
	    .append("title")
	    .text(function(d) { return d.category + ": " + formatAsInteger(d.measure); })
	    ;

	svg.append("text")
		.text("Fatality Rate")
		.attr("id","lineChartTitle1")	
		.attr("x",margin.left + ((width + margin.right)/2))
		.attr("y", 12)
		;

}

dsLineChart();


 /* ** UPDATE CHART ** */
 
/* updates bar chart on request */
function updateLineChart(group, colorChosen) {

	var currentDatasetLineChart = datasetLineChartChosen(group);   

	var basics = dsLineChartBasics();
	
	var margin = basics.margin,
		width = basics.width,
	   height = basics.height
		;

	var xScale = d3.scale.linear()
	    .domain([0, currentDatasetLineChart.length-1])
	    .range([0, width])
	    ;

	var yScale = d3.scale.linear()
	    .domain([0, d3.max(currentDatasetLineChart, function(d) { return d.measure; })])
	    .range([height, 0])
	    ;
	
	var line = d3.svg.line()
    .x(function(d, i) { return xScale(i); })
    .y(function(d) { return yScale(d.measure); })
    ;

   var plot = d3.select("#lineChartPlot")
   	.datum(currentDatasetLineChart)
	   ;
	   
	/* descriptive titles as part of plot -- start */
	var dsLength=currentDatasetLineChart.length;
	
	plot.select("text")
		.text(currentDatasetLineChart[dsLength-1].measure)
		;
	/* descriptive titles -- end */
	   
	plot
	.select("path")
		.transition()
		.duration(750)			    
	   .attr("class", "line")
	   .attr("d", line)	
	   // add color
		.attr("stroke", colorChosen)
	   ;
	   
	var path = plot
		.selectAll(".dot")
	   .data(currentDatasetLineChart)
	   .transition()
		.duration(750)
	   .attr("class", "dot")
	   .attr("fill", function (d) { return d.measure==d3.min(currentDatasetLineChart, function(d) { return d.measure; }) ? "red" : (d.measure==d3.max(currentDatasetLineChart, function(d) { return d.measure; }) ? "green" : "white") } )
	   .attr("cx", line.x())
	   .attr("cy", line.y())
	   .attr("r", 3.5)
	   // add color
		.attr("stroke", colorChosen)
	   ;
	   
	   path
	   .selectAll("title")
	   .text(function(d) { return d.category + ": " + formatAsInteger(d.measure); })	 
	   ;  

}

    </script>
  </body>
</html>

<!-- Part 3. Chart -->
<html>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<head>
<title>Covid-19 Global Pandemic Introduction</title>
<script src="http://d3js.org/d3.v2.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js"></script>
<script>

function getMaxObjectValue(metric, graph_metric) {
  var values = [];
	for (var i = 0; i < metric.length; i++) {
		for (var k = 0; k < graph_metric.length; k++) {
			if (parseFloat(metric[i][""+graph_metric[k]]) < 1) {
				values.push(parseFloat(metric[i][""+graph_metric[k]]));
			} else {
				values.push(Math.ceil(parseFloat(metric[i][""+graph_metric[k]])));
			}
		}
	}
	values.sort(function(a,b){return a-b});
	return values[values.length-1];
}

function getMinObjectValue(metric, graph_metric) {
	var values = [];
	for (var i = 0; i < metric.length; i++) {
		for (var k = 0; k < graph_metric.length; k++) {
			if (parseFloat(metric[i][""+graph_metric[k]]) < 1) {
				values.push(parseFloat(metric[i][""+graph_metric[k]]));
			} else {
				values.push(Math.floor(parseFloat(metric[i][""+graph_metric[k]])));
			}
		}
	}
	values.sort(function(a,b){return a-b});
	return values[0];
}

function getDate(d) {
    return new Date(d.date);
}

function buildLineChart(data, title, graph_metric, width, height, xaxislabel, yaxislabel) {
	
	var metric = data.slice(0);
	metric.splice(0,1);

	// define graph size parameters
	var margin = {top: 30, right: 20, bottom: 40, left: 86}, width = width - margin.left - margin.right, height = height - margin.top - margin.bottom;

	//color scale for multiple lines
	var colorscale = d3.scale.category10();

	var minDate = getDate(metric[0]),
	maxDate = getDate(metric[metric.length-1]),
	minObjectValue = getMinObjectValue(metric, graph_metric),
	maxObjectValue = getMaxObjectValue(metric, graph_metric);

	//create the graph object
	var vis= d3.select("#metrics").append("svg")
    	.data(metric)
		.attr("class", "metrics-container")
   		.attr("width", width + margin.left + margin.right)
    	.attr("height", height + margin.top + margin.bottom)
  	.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var y = d3.scale.linear().domain([ minObjectValue - (.1 * minObjectValue) , maxObjectValue + (.1 * maxObjectValue) ]).range([height, 0]),
	x = d3.time.scale().domain([minDate, maxDate]).range([0, width]);

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(5);
	
	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.ticks(2);

	vis.append("text")
		.attr("style", "font-family: Helvetica, Arial; font-size: 16px; font-weight: bold;")
		.attr("dx", function(d) { return 10; })
		.attr("dy", function(d) { return -10; })
		.text(''+title);

	//append the axes
	vis.append("g")
	    .attr("class", "axis")
	    .call(yAxis);
	
	vis.append("g")
		.attr("class", "axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call(xAxis);

	//add the axes labels
	vis.append("text")
	    .attr("class", "axis-label")

	    .attr("text-anchor", "end")
	    .attr("x", 20)
	    .attr("y", height + 34)
	    .text(xaxislabel);

	vis.append("text")
	    .attr("class", "axis-label")
	    .attr("text-anchor", "end")
	    .attr("y", 1)
	    .attr("dy", "-5em")
	    .attr("transform", "rotate(-90)")
	    .text(yaxislabel);

	var lines = [];
	var circles = [];

	//loop through graph objects, if it's a single graph there will only be one object
	for (var z = 0; z < graph_metric.length; z++) {
	
		lines[z] = d3.svg.line()
			.x(function(d) { return x(getDate(d)); })
			.y(function(d) { return (isNaN( y(d[''+graph_metric[z]])) ? 0 : y(d[''+graph_metric[z]])); })
		
		vis.append("svg:path")
			.attr("d", lines[z](metric))
			.style("stroke", function() { 
				return colorscale(""+z);
			})
			.style("fill", "none")
			.style("stroke-width", "2.5");
	
		var dataCirclesGroup = vis.append('svg:g');
		
		var circles = dataCirclesGroup.selectAll('.data-point')
			.data(metric);

		circles
			.enter()
			.append('svg:circle')
			.attr('class', 'dot')
			.attr('fill', function() { return colorscale(""+z); })
			.attr('cx', function(d) { return x(getDate(d)); })
			.attr('cy', function(d) { return (isNaN( y(d[''+graph_metric[z]])) ? 0 : y(d[''+graph_metric[z]])); })
			.attr('r', function() { return 3; })
			.on("mouseover", function(d) {
  				d3.select(this)
					.attr("r", 8)
					.attr("class", "dot-selected")
					.transition()
      					.duration(750);
			})
			.on("mouseout", function(d) {
  				d3.select(this)
					.attr("r", 3)
					.attr("class", "dot")
					.transition()
      					.duration(750);
			})
			.append("svg:title")
   			.text(function(d) { 
				var return_text = "";
				if (graph_metric.length > 1) {
					return_text += graph_metric[z] + "\n";
				}
				return_text += $.datepicker.formatDate('yy-mm-dd', new Date(d.date)) + ": ";
				return_text += Math.round(d[''+graph_metric[z]] * 100) / 100;
				return return_text;
			});

	}

}

function safeDivide(num1, num2) {
	if (isNaN(parseFloat(num2)) || isNaN(parseFloat(num1)) || num2 == 0) {
		return 0;
	}

	return Math.round( parseFloat(num1) / parseFloat(num2) * 100 ) / 100;
}

function getData() {
	
	var data = [];

	var metrics = 
		{"countries": 
			[
				{
					"country": "USA", 
					"metrics":
					[
						
						{
							"date"			  : "2020-05",
							"NEW_CASE_RATE"   : 0.8248,
							"CUM_CASES" 	  : 1075637,
							"recover_rate" 	  : 0.9637,
							"death_rate"      : 0.9318,
							"increasing_new_cases"    : 102,
							"increasing_new_deaths"    : 48,
							"increasing_new_recovered"   : 16
						},
						{
							"date"			  : "2020-06",
							"NEW_CASE_RATE"   : 0.3952,
							"CUM_CASES" 	  : 1778402,
							"recover_rate" 	  : 0.6738,
							"death_rate"      : 0.3916,
							"increasing_new_cases"    : 82,
							"increasing_new_deaths"    : 58,
							"increasing_new_recovered"   : 19
						},
						{
							"date"			  : "2020-07",
							"NEW_CASE_RATE"   : 0.3297,
							"CUM_CASES" 	  : 2653319,
							"recover_rate" 	  : 0.5161,
							"death_rate"      : 0.1858,
							"increasing_new_cases"    : 285,
							"increasing_new_deaths"    : 126,
							"increasing_new_recovered"   : 9
						},
						
						{
							"date"			  : "2020-08",
							"NEW_CASE_RATE"   : 0.4311,
							"CUM_CASES" 	  : 4663742,
							"recover_rate" 	  : 0.6369,
							"death_rate"      : 0.1824,
							"increasing_new_cases"    : 82,
							"increasing_new_deaths"    : 58,
							"increasing_new_recovered"   : 19
						}
					]
				},
				{
					"country": "Brazil", 
					"metrics":
					[
						
						{
							"date"			  : "2020-05",
							"NEW_CASE_RATE"   : 0.8363,
							"CUM_CASES" 	  : 6836,
							"recover_rate" 	  : 0.9967,
							"death_rate"      : 0.9039,
							"increasing_new_cases"    : 948,
							"increasing_new_deaths"    : 698,
							"increasing_new_recovered"   : 294
						},
						{
							"date"			  : "2020-06",
							"NEW_CASE_RATE"   : 0.9867,
							"CUM_CASES" 	  : 514849,
							"recover_rate" 	  : 0.8198,
							"death_rate"      : 0.9861,
							"increasing_new_cases"    : 1029,
							"increasing_new_deaths"    : 918,
							"increasing_new_recovered"   : 485
						},
						{
							"date"			  : "2020-07",
							"NEW_CASE_RATE"   : 0.6446,
							"CUM_CASES" 	  : 1448753,
							"recover_rate" 	  : 0.7418,
							"death_rate"      : 0.5165,
							"increasing_new_cases"    : 1349,
							"increasing_new_deaths"    : 1029,
							"increasing_new_recovered"   : 685
						},
						{
							"date"			  : "2020-08",
							"NEW_CASE_RATE"   : 0.4449,
							"CUM_CASES" 	  : 2610102,
							"recover_rate" 	  : 0.5822,
							"death_rate"      : 0.3356,
							"increasing_new_cases"    : 1029,
							"increasing_new_deaths"    : 918,
							"increasing_new_recovered"   : 485
						}
					]
				},
				{
					"country": "India", 
					"metrics":
					[
						
						{
							"date"			  : "2020-05",
							"NEW_CASE_RATE"   : 0.9464,
							"CUM_CASES" 	  : 37257,
							"recover_rate" 	  : 0.9852,
							"death_rate"      : 0.9526,
							"increasing_new_cases"    : 294,
							"increasing_new_deaths"    : 102,
							"increasing_new_recovered"   : 55
						},
						{
							"date"			  : "2020-06",
							"NEW_CASE_RATE"   : 0.8045,
							"CUM_CASES" 	  : 190609,
							"recover_rate" 	  : 0.8955,
							"death_rate"      : 0.7819,
							"increasing_new_cases"    : 304,
							"increasing_new_deaths"    : 198,
							"increasing_new_recovered"   : 78
						},
						{
							"date"			  : "2020-07",
							"NEW_CASE_RATE"   : 0.6848,
							"CUM_CASES" 	  : 604641,
							"recover_rate" 	  : 0.7339,
							"death_rate"      : 0.6855,
							"increasing_new_cases"    : 295,
							"increasing_new_deaths"    : 159,
							"increasing_new_recovered"   : 98
						},
						{
							"date"			  : "2020-08",
							"NEW_CASE_RATE"   : 0.6182,
							"CUM_CASES" 	  : 1583792,
							"recover_rate" 	  : 0.6590,
							"death_rate"      : 0.5007,
							"increasing_new_cases"    : 304,
							"increasing_new_deaths"    : 198,
							"increasing_new_recovered"   : 78
						}
					]
				}
    		]
		};

	var i = 0;

	$.each(metrics.countries, function() {
		data[i] = [];
		data[i][0] = this.country;
				
		$.each(this.metrics, function() {
			var metric = this;
			var temp_date = new Date(this.date);
	   			var month = temp_date.getMonth();
				var date = temp_date.getDate();
	   			var year = temp_date.getFullYear();
	   		metric.date = month + '/' + date + '/' + year;
			  //metric.date = month + '/' + date;
			data[i].push(metric);
		});
		i++;
	}); 

	return data;
	
}

function buildConsole(data) {
	var html = "";
	
	html += "<div id=\"country-selector\" class=\"console-element\">";
	for (var i = 0; i < data.length; i++) {
		html += "<div style=\"width: 150px; float: left;\">";
		html += "<input name=\"countries\" id=\"country-selector-" + data[i][0] + "\" type=\"checkbox\" ";
		if (i == 0) {
			html += "checked"; // set the first country to checked to provide some default data for the graphs
		}
		html += " value=\"" + data[i][0] + "\" /> ";
		html += data[i][0];
		html += "</div>";
	}
	html += "</div>";

	$('#console').html(html);	
	
}

function createAverages(metric) {
	for (var i = 1; i < metric.length; i++) {
		metric[i].increasing_new_cases_pct = safeDivide(metric[i].increasing_new_cases, metric[i].CUM_CASES) * 100;
		metric[i].increasing_new_deaths_pct = safeDivide(metric[i].increasing_new_deaths, metric[i].CUM_CASES) * 100;
		metric[i].increasing_new_recovered_pct = safeDivide(metric[i].increasing_new_recovered, metric[i].CUM_CASES) * 100;

		metric[i].average_session_length = safeDivide(metric[i].death_rate, metric[i].recover_rate) / 60;
		metric[i].average_recover_rate_per_user = safeDivide(metric[i].recover_rate, metric[i].NEW_CASE_RATE);
	}
	return metric;
}

function getCountries() {
	var elements = $("input:checkbox[name=countries]:checked");
	var countries = [];

	$.each(elements, function () {
		countries.push($(this).val());
	});

	return countries;
}

function aggregateMetric(metrics, countries) {
	var metric = []; 			 	//the single metric array of dates that we'll return,
					 			 	//aggregated over the selected countries
	var count = 0;   			 	// a count of countries being aggregated over

	for (var i = 0; i < metrics.length; i++) {
		if (jQuery.inArray(metrics[i][0], countries) > -1) { //this is a country we should aggregate for
			if (count == 0) {
				metric = cloneMetric(metrics[i]); // since metric is empty, set metric to the first set of metrics we find
				count++;
			} else {
				metric[0] = metric[0] + metrics[i][0]; //combine the country names for auditing
				for (var j = 1; j < metric.length; j++) {
					//iterate through metric[j] object and add metrics[i][j] values to it.
					//note: this requires that each country has the same number of days' worth of data!
					for (var key in metrics[i][j]) {
						if (key != "date") { // don't add the date
							metric[j][""+key] += metrics[i][j][""+key];
						}
					}
				}
				count++;
			}
		}
	}

	metric = createAverages(metric); //create the averaged values from the counts 
									 //(like retention metrics, average session length, etc.)

	return metric;
}

function resetCharts(metrics) {
	var countries = getCountries(); 					// get checked items
	var metric = aggregateMetric(metrics, countries);   // build one metric item out of the selected countries and the full dataset
	$('#metrics').html(''); 							// reset the metrics div html

	buildLineChart(metric, "All Cases", ['increasing_new_cases_pct', 'increasing_new_deaths_pct', 'increasing_new_recovered_pct'], 1000, 300, "2020", "All Cases (percentage)");
	//buildLineChart(metric, "All Cases", ['CUM_CASES'], 500, 300, "2020", "New Cases");
	buildLineChart(metric, "Cumulative Cases", ['CUM_CASES'], 500, 300, "2020", "New Cases");
	buildLineChart(metric, "Average New Case Rate", ['NEW_CASE_RATE'], 500, 300, "2020", "Cases");
	buildLineChart(metric, "Average Death Rate", ['death_rate'], 500, 300, "2020", "Death Rate (%)");
	buildLineChart(metric, "Average Recover Rate", ['recover_rate'], 500, 300, "2020", "Recover Rate (%)");

}

function cloneData(data) {
	//create a "deep copy" of the objects within the metrics array
	//ensures that objects are not copied by reference
	var metrics = [];
	for (var i = 0; i < data.length; i++) {
		metrics.push(cloneMetric(data[i]));
	}
	return metrics;
}

function cloneMetric(metric) {
	var tmp = [];
	tmp[0] = metric[0];
	for (var k = 1; k < metric.length; k++) {
		tmp.push( jQuery.extend(true, {}, metric[k]) );
	}
	return tmp;
}

$(document).ready(function() {

	var data = getData();
	
	buildConsole(data);

	resetCharts(data);

	$('#country-selector').change(function() {
		var metrics = cloneData(data);
		$('#country-selector').stop().css("background-color", "#FFFF9C").animate({ backgroundColor: "#CCFFE6"}, 1500);
		resetCharts(metrics);
	}); 

});

</script>

<style>
.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke-width: 1.5px;

}

body { 
	background: #FFFFFF; 
	background-repeat:repeat-x;
	text-align: center;
	font: 11px sans-serif;
}

.dot {

  stroke-width: 1.5px;
}

.dot-selected {
  fill: #B0C4DE;
  stroke: #B0C4DE;
  stroke-width: 1.5px;
}

.metrics-container {
	width: auto;
	height: auto;
	padding: 10px 10px 10px 10px;
	border-style: solid;
	border-width: 1px;
	float: left;
	margin-left: 20px;

	margin-top: 20px;
}

#console {
	background-color: #CCFFE6;
	font-size: 22px;
	margin: 4px 4px 4px 4px;
	padding: 4px 4px 4px 4px;
	width: 95%;
	float: left;
	text-align: left;
}
</style>

</head>

<body>

	<h1> Top 3 Covid-19 Countries in the World (by July 31, 2020)</h1>

	<div id="console">
	</div>

	<div id="metrics">
	</div>

</body>
</html>